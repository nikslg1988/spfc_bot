import logging
from config import DEEPSEEK_API_KEY 
from aiohttp import ClientSession, ClientTimeout

DEEPSEEK_URL = "https://api.deepseek.com/chat/completions"

HEADERS = {
    "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
    "Content-Type": "application/json",
}


async def analyze_food(food_text: str, daily_calories: int) -> str:
    """
    Функция для анализа пищи с помощью LLM.

    Входные параметры:
    - food_text: текстовое описание еды
    - daily_calories: суточная норма калорий пользователя

    Возвращает:
    - текстовый результат анализа

    Гарантии:
    - всегда возвращает str
    - не выбрасывает исключения наружу
    """
    
    fallback_text = (
        "Извините, не удалось проанализировать вашу еду в данный момент. "
        "Пожалуйста, попробуйте снова позже."
    )
    
    try:
        prompt = _build_prompt(food_text, daily_calories)
        answer = await _call_llm(prompt)
        if not isinstance(answer, str) or len(answer.strip()) == 0:
            return fallback_text
        return answer
    
    except Exception as exc:
        logging.exception("LLM error in analyze_food")
        return fallback_text
    
async def _call_llm(prompt: str) -> str:
    """
    Асинхронный вызов LLM.

    Принимает:
    - prompt: готовый текст запроса

    Возвращает:
    - строку с ответом модели

    Гарантии:
    - всегда возвращает str
    - не выбрасывает исключения наружу
    """
    try:

        headers = {
            "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
            "Content-Type": "application/json",
        }

        payload = {
            "model": "deepseek-chat",
            "messages": [
                {"role": "user", "content": prompt}
            ]
        }

        async with ClientSession() as session:
            async with session.post(
                DEEPSEEK_URL,
                headers=headers,
                json=payload,
                timeout=ClientTimeout(total=20),
            ) as response:

                raw_text = await response.text()
                print("LLM RAW RESPONSE:")
                print(raw_text)

                if response.status != 200:
                    print("LLM NON-200 STATUS")
                    return ""

                data = await response.json()

                choices = data.get("choices")
                if not choices or not isinstance(choices, list):
                    print("LLM NO CHOICES")
                    return ""

                message = choices[0].get("message", {})
                content = message.get("content")

                if not isinstance(content, str):
                    return ""

                return content.strip()

    except Exception as exc:
        return ""


def _build_prompt(food_text: str, daily_calories: int) -> str:
    """
    Формирование промта
    Принимает: 
    - food_text: 
    - daily_calories:
    
    Возвращает:
    строку
    
    Гарантии:
    - всегда возвращает str
    - не выбрасывает исключения наружу
    
    """

    prompt = f"""РОЛЬ И НАЗНАЧЕНИЕ

    Ты — языковая модель, выполняющая ориентировочную качественную оценку калорийности приёма пищи на основе текстового описания еды.

    Твоя задача — дать приблизительную, понятную человеку оценку, чтобы показать масштаб приёма пищи, без точных вычислений и без претензии на фактическую точность.

    Ты НЕ являешься диетологом, врачом или медицинским специалистом.
    Ты НЕ выполняешь точные расчёты, НЕ используешь формулы и НЕ даёшь персональных рекомендаций.

    Все оценки, которые ты даёшь, являются ориентировочными, примерными и приближёнными.

    ВХОДНЫЕ ДАННЫЕ (ТЫ ПОЛУЧАЕШЬ ИХ В ЯВНОМ ВИДЕ)

    Текстовое описание еды в свободной форме: 
    (например: «гречка 200 г, курица 150 г, яблоко»).

    Суточная норма калорий пользователя — одно целое число
    (например: 2200).
    
    Описание еды: {food_text}
    Суточная норма калорий: {daily_calories}

    Ты не должен догадываться, как была получена суточная норма,
    и не должен делать предположений о пользователе
    (возраст, вес, пол, здоровье, цели и т.п.).

    СТРОГИЕ ЗАПРЕТЫ (ОБЯЗАТЕЛЬНЫ К СОБЛЮДЕНИЮ)

    Тебе запрещено:

    выполнять точные расчёты калорий;

    указывать точные числовые значения без оговорки приблизительности;

    использовать математические формулы или алгоритмы расчёта;

    анализировать или упоминать БЖУ, макро- и микроэлементы;

    давать медицинские советы или рекомендации, связанные со здоровьем;

    давать категоричные указания
    («нужно», «следует», «нельзя», «обязательно»);

    оценивать личность пользователя или его выбор еды.

    Допускается использование приблизительных чисел, диапазонов или процентов,
    только если они явно сопровождаются словами
    «примерно», «ориентировочно», «порядка», «на глаз».

    Если возникает риск нарушения любого из пунктов —
    ты обязан упростить ответ, а не расширять его.

    СТРОГО ЗАДАННАЯ СТРУКТУРА ОТВЕТА

    Твой ответ всегда должен следовать этому порядку
    и не может быть изменён.

    Каждый пункт — одно предложение.
    Весь ответ — не более 4 предложений.

    Ориентировочная оценка приёма пищи
    Краткое словесное описание уровня калорийности
    (например: «низкая», «умеренная», «выше средней»).

    Сравнение с суточной нормой
    Неформальное сравнение приёма пищи с указанной нормой
    (например: «занимает небольшую часть суточной нормы»,
    «составляет заметную часть дневной нормы»).

    Короткий нейтральный вывод
    1–2 предложения без советов, без указаний и без выводов о пользователе.

    Никаких дополнительных разделов, списков или пояснений добавлять нельзя.

    ТОН И СТИЛЬ

    нейтральный;

    информативный;

    без морализаторства;

    без эмоциональной окраски;

    без оценок личности пользователя.
    
    """
    return prompt
